---
# tasks file for drupal7_on_ubuntu20

- name: Update apt cache if needed.
  apt: update_cache=yes cache_valid_time=3600


- name: Get software for apt repository management.
  apt:
    state: present
    name:
      - python3-apt
      - python3-pycurl

- name: Add ondrej repository for later versions of PHP.
  apt_repository: repo='ppa:ondrej/php' update_cache=yes

- name: "Install Apache, MySQL, PHP, and other dependencies."
  apt:
    state: present
    name:
      - acl
      - git
      - curl
      - unzip
      - sendmail
      - apache2
      - php7.4-common
      - php7.4-cli
      - php7.4-dev
      - php7.4-gd
      - php7.4-curl
      - php7.4-json
      - php7.4-opcache
      - php7.4-xml
      - php7.4-mbstring
      - php7.4-pdo
      - php7.4-mysql
      - php-apcu
      - libpcre3-dev
      - libapache2-mod-php7.4
      - python3-mysqldb
      - mysql-server
      - ufw

- name: Disable the firewall (since this is for local dev only).
  service: name=ufw state=stopped

- name: "Start Apache, MySQL, and PHP."
  service: "name={{ item }} state=started enabled=yes"
  with_items:
    - apache2

# chub hack to start mysql
- name: start mysql
  command: " /etc/init.d/mysql start"



- name: Enable Apache rewrite module (required for Drupal).
  apache2_module: name=rewrite state=present
  notify: restart apache

- name: Add Apache virtualhost for Drupal.
  template:
    src: "templates/drupal.test.conf.j2"
    dest: "/etc/apache2/sites-available/{{ domain }}.test.conf"
    owner: "{{ root_user }}"
    group: "{{ root_user }}"
    mode: 0644
  notify: restart apache

- name: Enable the Drupal site.
  command: >
    a2ensite {{ domain }}.test
    creates=/etc/apache2/sites-enabled/{{ domain }}.test.conf
  notify: restart apache

- name: Disable the default site.
  command: >
    a2dissite 000-default
    removes=/etc/apache2/sites-enabled/000-default.conf
  notify: restart apache

- name: Adjust OpCache memory setting.
  lineinfile:
    dest: "/etc/php/7.4/apache2/conf.d/10-opcache.ini"
    regexp: "^opcache.memory_consumption"
    line: "opcache.memory_consumption = 96"
    state: present
  notify: restart apache


- name: Create a MySQL database for Drupal.
  mysql_db:
    config_file: /etc/mysql/my.cnf
    name: "{{ drupal_db_name }}"
    state: present
- name: Create a MySQL user for Drupal.
  mysql_user:
    name: "{{ drupal_db_user }}"
    password: "{{ drupal_db_passwd }}"
    priv: "{{ domain }}.*:ALL"
    host: localhost
    state: present

- name: Ensure git directory exists.
  file:
    path: "{{ project_path }}"
    state: directory
    owner: "{{ root_user }}"
    group: "{{ root_user }}"

# check ansible.cfg in this directory [ssh_connection] ssh_args=-o ForwardAgent=yes
# ssh-keygen -f "/home/chub/.ssh/known_hosts" -R "172.17.0.2"
- name: Clone a private repository into {{ project_path }}.
  git:
    repo: git@github.com:christophe-hubert/bruxeo7.git
    version: main
    dest: "{{ project_path }}"
    accept_hostkey: yes
  # ssh-agent doesn't allow key to pass through remote sudo commands.
  become: no

- name: git directory ownership.
  file:
    path: "{{ project_path }}"
    state: directory
    owner: "{{ root_user }}"
    group: "{{ root_user }}"
    recurse: yes
- name: ownership of drupal
  file:
    path: "{{ drupal_path }}"
    state: directory
    owner: www-data
    group: www-data
    recurse: yes

